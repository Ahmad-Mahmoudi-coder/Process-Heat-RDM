# Thesis Artefacts Documentation

This document provides an authoritative map of all artefacts produced by the PoC pipeline, organized by epoch and layer.

## Canonical Folder Structure

All outputs follow this structure:
```
Output/runs/<bundle>/
├── epoch<epoch_tag>/
│   ├── demandpack/
│   │   ├── demandpack/
│   │   │   └── hourly_heat_demand_<epoch>.csv
│   │   ├── meta/
│   │   │   └── run_manifest.json
│   │   └── figures/
│   │       ├── demand_<epoch_tag>_timeseries_sample.png
│   │       ├── demand_<epoch_tag>_duration_curve.png
│   │       ├── demand_<epoch_tag>_heatmap_day_hour.png
│   │       ├── demand_<epoch_tag>_monthly_totals.png
│   │       └── demand_<epoch_tag>_avg_diurnal_by_season.png
│   ├── dispatch/
│   │   └── <runid>/
│   │       ├── site_dispatch_<epoch_tag>_long.csv
│   │       ├── site_dispatch_<epoch_tag>_long_costed.csv
│   │       ├── site_dispatch_<epoch_tag>_wide.csv
│   │       ├── site_dispatch_<epoch_tag>_summary.csv
│   │       ├── signals/
│   │       │   └── incremental_electricity_MW_<epoch_tag>.csv
│   │       ├── signals_used/
│   │       │   └── tariff_nzd_per_MWh_<epoch_tag>.csv
│   │       └── figures/
│   │           └── heat_<epoch_tag>_unit_stack.png
│   └── regional_signals/
│       └── <runid>/
│           ├── signals/
│           │   ├── headroom_MW_<epoch_tag>.csv
│           │   ├── tariff_nzd_per_MWh_<epoch_tag>.csv
│           │   └── gxp_capacity_MW_<epoch_tag>.csv
│           └── figures/
│               ├── headroom_duration_curve_<epoch_tag>.png
│               ├── headroom_timeseries_week_<epoch_tag>.png
│               └── tariff_timeseries_week_<epoch_tag>.png
├── kpi_table_<runid>.csv
├── compare_pathways_2035_EB_vs_BB.csv
├── rdm/
│   ├── rdm_summary_2035_EB.csv
│   ├── rdm_summary_2035_BB.csv
│   ├── rdm_compare_2035_EB_vs_BB.csv
│   ├── rdm_matrix_2035_EB.csv
│   └── rdm_matrix_2035_BB.csv
└── thesis_pack/
    ├── tables/
    └── figures/
```

## Epochs

The PoC pipeline supports the following epochs:
- **2020**: Baseline year
- **2025**: Near-term projection
- **2028**: Mid-term projection
- **2035_EB**: 2035 Electrified Boiler pathway
- **2035_BB**: 2035 Biomass Boiler pathway

## Layer 1: DemandPack Artefacts

### Hourly Heat Demand CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/demandpack/demandpack/hourly_heat_demand_<epoch>.csv`

**Generation Command:**
```bash
python -m src.generate_demandpack --config Input/configs/demandpack_<epoch>.toml --epoch <epoch>
```

**Purpose:** Synthetic hourly heat demand profile generated from annual targets, seasonal factors, weekday patterns, and hourly profiles.

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `heat_demand_MW`: Hourly heat demand (MW)

**Thesis Use:** Primary input for site dispatch. Used to validate demand patterns and seasonal variations.

### DemandPack Run Manifest
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/demandpack/meta/run_manifest.json`

**Generation Command:** (Automatically generated by DemandPack)

**Purpose:** Provenance metadata for DemandPack run, including config path, factor file hashes, and run parameters.

**Thesis Use:** Traceability and reproducibility documentation.

### DemandPack Figures
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/demandpack/figures/demand_<epoch_tag>_*.png`

**Generation Command:**
```bash
# Automatically generated by run_poc_layers.ps1 -Layers demandpack
python -m src.plot_demandpack --input-csv <staged_csv> --epoch-tag <epoch_tag> --outdir <bundle_figures_dir>
```

**Figures:**
- `demand_<epoch_tag>_timeseries_sample.png`: Sample weeks showing representative periods (January, June, October)
- `demand_<epoch_tag>_duration_curve.png`: Load duration curve (sorted descending)
- `demand_<epoch_tag>_heatmap_day_hour.png`: Heatmap of average demand by day of week and hour of day
- `demand_<epoch_tag>_monthly_totals.png`: Monthly totals bar chart (GWh)
- `demand_<epoch_tag>_avg_diurnal_by_season.png`: Average diurnal profile by season (Summer, Autumn, Winter, Spring)

**Thesis Use:** Thesis-ready plots for demand profile visualization and validation. Automatically staged to bundle and copied to thesis_pack.

## Layer 2: Site Dispatch Artefacts

### Dispatch Long-Form CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/site_dispatch_<epoch_tag>_long.csv`

**Generation Command:**
```bash
python -m src.site_dispatch_2020 --epoch <epoch_tag> --mode proportional --demand-csv <demand_csv> --output-root Output --run-id <bundle>/epoch<epoch_tag>/dispatch/<runid>
```

**Purpose:** Long-form dispatch data with one row per unit per hour.

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `unit_id`: Unit identifier
- `heat_MW`: Heat output (MW)
- `fuel_MWh`: Fuel consumption (MWh)
- `electricity_MWh`: Electricity consumption (MWh, for EB units)
- `co2_tonnes`: CO2 emissions (tonnes)

**Thesis Use:** Detailed hourly dispatch data for analysis and validation.

### Dispatch Long-Form Costed CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/site_dispatch_<epoch_tag>_long_costed.csv`

**Generation Command:** (Same as long-form, automatically generated in proportional mode)

**Purpose:** Long-form dispatch data with cost components added.

**Additional Columns:**
- `fuel_cost_nzd`: Fuel cost (NZD)
- `electricity_cost_nzd`: Electricity cost (NZD)
- `electricity_tariff_nzd_per_MWh`: Electricity tariff (NZD/MWh)
- `carbon_cost_nzd`: Carbon cost (NZD)
- `unserved_cost_nzd`: Unserved cost (NZD)
- `unserved_penalty_nzd_per_MWh`: Unserved penalty (NZD/MWh)

**Thesis Use:** Cost analysis and validation of electricity pricing.

### Dispatch Wide-Form CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/site_dispatch_<epoch_tag>_wide.csv`

**Generation Command:** (Same as long-form, automatically generated)

**Purpose:** Wide-form dispatch data with one row per hour, columns per unit.

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `total_heat_MW`: Total heat demand (MW)
- `<unit_id>_MW`: Heat output per unit (MW)

**Thesis Use:** Time-series visualization and unit contribution analysis.

### Dispatch Summary CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/site_dispatch_<epoch_tag>_summary.csv`

**Generation Command:** (Same as long-form, automatically generated)

**Purpose:** Annual summary of site dispatch by unit (TOTAL row contains system aggregates).

**Key Columns:**
- `unit_id`: Unit identifier (TOTAL = system aggregate, UNSERVED = unserved energy)
- `annual_total_cost_nzd`: Total annual cost (NZD)
- `annual_fuel_cost_nzd`: Annual fuel cost (NZD)
- `annual_electricity_cost_nzd`: Annual electricity cost (NZD)
- `annual_electricity_MWh`: Annual electricity consumption (MWh)
- `avg_electricity_tariff_nzd_per_MWh`: Average electricity tariff (NZD/MWh)
- `annual_co2_tonnes`: Annual CO2 emissions (tonnes)
- `annual_carbon_cost_nzd`: Annual carbon cost (NZD)
- `annual_unserved_MWh`: Annual unserved energy (MWh)
- `annual_unserved_cost_nzd`: Annual unserved cost (NZD)
- `unserved_avg_cost_nzd_per_MWh`: Average unserved cost per MWh (NZD/MWh)
- `avg_cost_nzd_per_MWh_heat`: Average cost per MWh heat (NZD/MWh)

**Electricity Effective Columns:**
- `annual_electricity_MWh_effective`: Effective annual electricity consumption (MWh) - uses reported value if non-zero, otherwise derived from EB unit fuel accounting
- `annual_electricity_cost_nzd_effective`: Effective annual electricity cost (NZD) - uses reported value if non-zero, otherwise derived from EB unit fuel accounting
- `avg_electricity_tariff_nzd_per_MWh_effective`: Effective average electricity tariff (NZD/MWh) - computed from effective cost and consumption
- `annual_electricity_MWh_derived`: Derived annual electricity consumption (MWh) - computed from EB unit fuel_MWh (for cases where explicit electricity fields are zero)
- `annual_electricity_cost_nzd_derived`: Derived annual electricity cost (NZD) - computed from EB unit fuel_cost_nzd
- `avg_electricity_tariff_nzd_per_MWh_derived`: Derived average electricity tariff (NZD/MWh) - computed from derived cost and consumption

**Note:** Electricity effective totals are derived from EB unit fuel accounting when explicit electricity fields are zero. This ensures EB vs BB comparisons are meaningful even when electricity consumption appears under fuel accounting rather than explicit electricity fields.

**Thesis Use:** Primary KPI table for cost, emissions, and electricity consumption comparison.

### Incremental Electricity Trace
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/signals/incremental_electricity_MW_<epoch_tag>.csv`

**Generation Command:** (Automatically generated when electric units are present)

**Purpose:** Hourly incremental electricity demand exported from site dispatch for regional screening.

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `incremental_electricity_MW`: Incremental electricity demand (MW)

**Thesis Use:** Input to regional electricity screening/RDM module.

### Signals Used (Provenance)
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/signals_used/tariff_nzd_per_MWh_<epoch_tag>.csv`

**Generation Command:** (Automatically generated by dispatch module)

**Purpose:** Records the electricity tariff time-series used for costing (for provenance/reproducibility).

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `tariff_nzd_per_MWh`: Electricity tariff (NZD/MWh)

**Thesis Use:** Provenance tracking for reproducibility.

### Dispatch Figures
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/dispatch/<runid>/figures/heat_<epoch_tag>_unit_stack.png`

**Generation Command:**
```bash
python -m src.site_dispatch_2020 --epoch <epoch_tag> --mode proportional --plot --demand-csv <demand_csv> --output-root Output --run-id <bundle>/epoch<epoch_tag>/dispatch/<runid>
```

**Figures:**
- `heat_<epoch_tag>_unit_stack.png`: Stacked plot showing hourly heat dispatch by unit

**Thesis Use:** Visual representation of dispatch patterns and unit contributions.

## Layer 3: Regional Electricity Signals

**Layer:** Regional Signals (PoC)  
**Epochs:** All epochs (2020, 2025, 2028, 2035_EB, 2035_BB)

**Note:** This layer generates deterministic PoC regional electricity signals (headroom, tariff, capacity) as reporting artefacts. These signals use the same deterministic logic embedded in RDM screening. No coupling/feedback: purely reporting artefacts.

### Headroom Signal CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/regional_signals/<runid>/signals/headroom_MW_<epoch_tag>.csv`

**Generation Command:**
```bash
# Automatically generated by run_poc_layers.ps1 -Layers regional_signals
python -m src.generate_regional_signals_poc --epoch-tag <epoch_tag> --outdir <output_dir>
```

**Purpose:** Deterministic headroom signal with seasonal and weekly patterns.

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `headroom_MW`: Headroom (MW)

**Logic:**
- Base headroom: 50 MW
- Seasonal variation: ±20 MW (sine wave, peak in summer)
- Weekly pattern: weekend +5 MW
- Minimum: 10 MW

**Thesis Use:** Reporting artefact showing deterministic headroom assumptions.

### Tariff Signal CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/regional_signals/<runid>/signals/tariff_nzd_per_MWh_<epoch_tag>.csv`

**Generation Command:** (Same as headroom)

**Purpose:** Deterministic tariff signal (flat tariff from signals config).

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `tariff_nzd_per_MWh`: Tariff (NZD/MWh)

**Logic:**
- Flat tariff from `Input/signals/signals_config.toml` for the epoch
- No time-of-use variation (PoC simplification)

**Thesis Use:** Reporting artefact showing deterministic tariff assumptions.

### GXP Capacity CSV
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/regional_signals/<runid>/signals/gxp_capacity_MW_<epoch_tag>.csv`

**Generation Command:** (Same as headroom)

**Purpose:** GXP capacity signal (constant or timeseries).

**Key Columns:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `gxp_capacity_MW`: GXP capacity (MW)

**Logic:**
- Constant capacity (200 MW default for PoC)
- Can be extended to timeseries if needed

**Thesis Use:** Reporting artefact showing GXP capacity assumptions.

### Regional Signals Figures
**Path Template:** `Output/runs/<bundle>/epoch<epoch_tag>/regional_signals/<runid>/figures/*_<epoch_tag>.png`

**Generation Command:** (Automatically generated alongside signals)

**Figures:**
- `headroom_duration_curve_<epoch_tag>.png`: Headroom duration curve (sorted descending)
- `headroom_timeseries_week_<epoch_tag>.png`: One representative week of headroom (first week of February)
- `tariff_timeseries_week_<epoch_tag>.png`: One representative week of tariff (first week of February)

**Thesis Use:** Visual representation of deterministic regional signals assumptions.

## Layer 4: RDM Screening Artefacts

### RDM Summary CSV (EB)
**Path Template:** `Output/runs/<bundle>/rdm/rdm_summary_2035_EB.csv`

**Generation Command:**
```bash
python -m src.run_rdm_2035 --bundle <bundle> --run-id <runid> --epoch-tag 2035_EB --output-root Output
```

**Purpose:** RDM screening results for EB pathway across uncertainty futures.

**Key Columns:**
- `epoch_tag`: Epoch tag (`2035_EB`)
- `strategy_id`: Strategy ID (`S_AUTO`)
- `strategy_label`: Strategy label
- `future_id`: Future ID (from `Input/rdm/futures_2035.csv`)
- `selected_upgrade_name`: Selected upgrade option name
- `selected_capacity_MW`: Selected upgrade capacity (MW)
- `annualised_upgrade_cost_nzd`: Annualised upgrade cost (NZD/year)
- `annual_incremental_MWh`: Annual incremental electricity demand (MWh)
- `annual_shed_MWh`: Annual shed energy (MWh)
- `shed_fraction`: Shed fraction (0-1)
- `annual_shed_cost_nzd`: Annual shed cost (NZD)
- `total_cost_nzd`: Total cost (upgrade + shed, NZD)
- `n_hours_binding`: Number of hours with binding constraints
- `unserved_peak_MW`: Peak unserved demand (MW)

**Thesis Use:** Robustness evaluation of EB pathway under uncertainty.

### RDM Summary CSV (BB)
**Path Template:** `Output/runs/<bundle>/rdm/rdm_summary_2035_BB.csv`

**Generation Command:**
```bash
python -m src.run_rdm_2035 --bundle <bundle> --run-id <runid> --epoch-tag 2035_BB --output-root Output
```

**Purpose:** RDM screening results for BB pathway across uncertainty futures.

**Key Columns:** (Same as EB summary)

**Thesis Use:** Robustness evaluation of BB pathway under uncertainty.

**Critical Requirement:** EB and BB summaries must use **identical `future_id` sets** (paired futures) from `Input/rdm/futures_2035.csv`.

### RDM Comparison CSV
**Path Template:** `Output/runs/<bundle>/rdm/rdm_compare_2035_EB_vs_BB.csv`

**Generation Command:**
```bash
python -m src.run_rdm_2035 --bundle <bundle> --run-id <runid> --epoch-tag 2035_EB --output-root Output --create-comparison
```

**Purpose:** Side-by-side comparison of EB vs BB RDM results by `future_id`.

**Key Columns:**
- `future_id`: Future ID (shared across EB and BB)
- `selected_upgrade_name_EB`, `selected_upgrade_name_BB`: Selected upgrades
- `total_cost_nzd_EB`, `total_cost_nzd_BB`: Total costs
- `annual_shed_MWh_EB`, `annual_shed_MWh_BB`: Annual shed energy
- (Other metrics with `_EB` and `_BB` suffixes)

**Thesis Use:** Direct comparison of robustness metrics between pathways.

### RDM Matrix CSV (EB)
**Path Template:** `Output/runs/<bundle>/rdm/rdm_matrix_2035_EB.csv`

**Generation Command:**
```bash
# Automatically generated by run_rdm_2035 (always generated alongside summary)
python -m src.run_rdm_2035 --bundle <bundle> --run-id <runid> --epoch-tag 2035_EB --output-root Output
```

**Purpose:** Long-form strategy table with one row per (future_id, strategy_id) combination. Includes all upgrade options as strategies (S0, S1, S2, ...) plus S_AUTO (auto-select benchmark) for each future.

**Key Columns:**
- `epoch_tag`: Epoch tag (`2035_EB`)
- `strategy_id`: Strategy ID (`S0`, `S1`, `S2`, `S3`, `S4`, `S_AUTO`)
- `strategy_label`: Strategy label
- `future_id`: Future ID
- `U_inc_mult`, `U_headroom_mult`, `U_upgrade_capex_mult`, `U_voll`, `U_consents_uplift`: Uncertainty multipliers
- `selected_upgrade_name`: Selected upgrade option name
- `selected_capacity_MW`: Selected upgrade capacity (MW)
- `annualised_upgrade_cost_nzd`: Annualised upgrade cost (NZD/year)
- `annual_incremental_MWh`: Annual incremental electricity demand (MWh)
- `annual_shed_MWh`: Annual shed energy (MWh)
- `shed_fraction`: Shed fraction (0-1)
- `annual_shed_cost_nzd`: Annual shed cost (NZD)
- `total_cost_nzd`: Total cost (upgrade + shed, NZD)
- `max_exceed_MW`: Maximum exceedance (MW)
- `p95_exceed_MW`, `p99_exceed_MW`: 95th and 99th percentile exceedance (MW, computed on exceed>0 distribution)
- `hours_exceed`: Number of hours with exceedance > 0
- `hours_shed`: Number of hours with shed > 0
- `menu_max_capacity_MW`: Maximum capacity in upgrade menu (MW)
- `menu_max_selected`: Boolean indicating if selected capacity equals menu maximum
- `satisficing_pass`: Boolean indicating if strategy satisfies constraints (annual_shed_MWh <= tol AND hours_exceed == 0)
- `voll_nzd_per_MWh_used`: Value of lost load used (NZD/MWh)
- `is_benchmark`: Boolean (TRUE for S_AUTO)
- `is_policy`: Boolean (TRUE for S0-S4, FALSE for S_AUTO)
- `regret_vs_benchmark_nzd`: Regret vs S_AUTO benchmark (NZD)
- `regret_vs_best_policy_nzd`: Regret vs best policy strategy (NZD)
- `regret`: Regret vs benchmark (NZD, alias for regret_vs_benchmark_nzd)

**Thesis Use:** Detailed strategy evaluation matrix for robustness analysis. Enables comparison of all upgrade options across all futures, including regret analysis and satisficing evaluation.

### RDM Matrix CSV (BB)
**Path Template:** `Output/runs/<bundle>/rdm/rdm_matrix_2035_BB.csv`

**Generation Command:**
```bash
# Automatically generated by run_rdm_2035 (always generated alongside summary)
python -m src.run_rdm_2035 --bundle <bundle> --run-id <runid> --epoch-tag 2035_BB --output-root Output
```

**Purpose:** Same as EB matrix, but for BB pathway.

**Key Columns:** (Same as EB matrix)

**Thesis Use:** Detailed strategy evaluation matrix for BB pathway robustness analysis.

**Note:** The matrix files are automatically generated whenever RDM screening is run. They provide the full strategy-by-future evaluation needed for detailed robustness analysis, while the summary files (`rdm_summary_*.csv`) contain only the S_AUTO (benchmark) results.

### Site Decision Robustness Consolidation (PoC v2)

**Path Template:** `Output/runs/<bundle>/rdm/site_decision_robustness_2035_EB_vs_BB.csv`

**Generation Command (PowerShell - Copy-Paste Ready):**
```powershell
# Set bundle name
$bundle = "poc_20260105_release02"

# Step 1: Initialize canonical futures.csv and site multipliers (first time only)
python -m src.site_decision_robustness --bundle $bundle --init-futures-multipliers

# Step 2: Validate setup (check files, schema, paired futures, multiplier status)
python -m src.site_decision_robustness --bundle $bundle --validate-only

# Step 3: Generate robustness consolidation
python -m src.site_decision_robustness --bundle $bundle --epoch-eb 2035_EB --epoch-bb 2035_BB

# Optional: Force regenerate multipliers (uses seed from config for reproducibility)
python -m src.site_decision_robustness --bundle $bundle --init-futures-multipliers --force-init
```

**Purpose:** PoC v2 reporting overlay that consolidates site dispatch costs with RDM upgrade costs to evaluate robustness of EB vs BB pathway decisions under uncertainty. Introduces stylised uncertainty multipliers for site costs to make site decision robustness non-trivial while keeping one-pass coupling intact.

**Key Concept:** This is a **post-processing overlay only**. It does NOT re-run dispatch, modify existing artefacts, introduce feedback loops, or change the pipeline order. It reads existing outputs and applies per-future multipliers to perturb site-side cost components.

**Key Columns (Per-Future Table):**
- `future_id`: Future ID (paired with RDM summaries)
- **Baseline fields:**
  - `EB_site_cost_nzd`, `BB_site_cost_nzd`: Original annual_total_cost_nzd from dispatch
  - `EB_rdm_cost_nzd`, `BB_rdm_cost_nzd`: RDM upgrade + shed costs
  - `EB_system_cost_nzd`, `BB_system_cost_nzd`: Baseline composite (site + RDM)
- **Multipliers:**
  - `P_elec_mult`: Electricity price multiplier
  - `P_biomass_mult`: Biomass fuel price multiplier / scarcity proxy
  - `ETS_mult`: Carbon price (ETS) multiplier
- **Future-costed fields:**
  - `EB_site_cost_future_nzd`, `BB_site_cost_future_nzd`: Site costs with multipliers applied
  - `EB_system_cost_future_nzd`, `BB_system_cost_future_nzd`: Future-costed system costs
  - `winner_system_cost_future`: Winner pathway ("EB" or "BB")
  - `regret_EB_future_nzd`, `regret_BB_future_nzd`: Regret vs winner
- **Interpretability deltas:**
  - `delta_site_cost_future_nzd`: EB - BB site cost difference
  - `delta_upgrade_cost_nzd`: EB - BB upgrade cost difference
  - `delta_system_cost_future_nzd`: EB - BB system cost difference
- **Other fields:** Upgrade names, capacities, shed fractions, shed MWh, CO2 emissions, electricity consumption

**Summary Metrics CSV:**
**Path Template:** `Output/runs/<bundle>/rdm/site_decision_robustness_summary_2035.csv`

**Key Metrics:**
- `n_futures`: Number of futures evaluated
- `win_rate_EB_system_cost_future`: Percentage of futures where EB wins (lower future-costed system cost)
- `mean_regret_EB_nzd`, `p95_regret_EB_nzd`, `max_regret_EB_nzd`: Regret statistics for EB
- `mean_regret_BB_nzd`, `p95_regret_BB_nzd`, `max_regret_BB_nzd`: Regret statistics for BB
- `upgrade_exposure_EB_P150`, `upgrade_exposure_BB_P150`: Share of futures with selected_capacity_MW >= 150
- `satisficing_rate_EB`, `satisficing_rate_BB`: Share of futures satisfying thresholds (shed_fraction <= 0, upgrade_cost <= 7M NZD)

**Figures:**
- `site_decision_regret_cdf_2035.png`: Regret CDF comparison (EB vs BB) using future-costed regrets
- `site_decision_system_cost_boxplot_2035.png`: System cost distribution comparison (EB vs BB)

**Canonical Futures CSV (with Site Multipliers):**
**Path Template:** `Output/runs/<bundle>/rdm/futures.csv`

**Purpose:** Canonical per-bundle futures file containing both grid multipliers (from template) and site multipliers (generated). Ensures paired futures are consistent across EB and BB pathways.

**Creation:** Created from template `Input/rdm/futures_2035.csv` on first run with `--init-futures-multipliers`. Site multiplier columns are then added using configured distributions and ranges.

**Schema:**
- `future_id`: Future ID (integer, must exactly match RDM summaries)
- **Grid multipliers (from template):**
  - `U_headroom_mult`: Headroom multiplier
  - `U_inc_mult`: Incremental demand multiplier
  - `U_upgrade_capex_mult`: Upgrade capex multiplier
  - `U_voll`: Value of lost load (NZD/MWh)
  - `U_consents_uplift`: Consents uplift multiplier
- **Site multipliers (generated):**
  - `P_elec_mult`: Electricity price multiplier (default range: [0.65, 1.35], triangular, mode=1.0)
  - `P_biomass_mult`: Biomass fuel price multiplier / scarcity proxy (default range: [0.90, 2.50], triangular, mode=1.2)
  - `ETS_mult`: Carbon price (ETS) multiplier (default range: [0.80, 2.00], triangular, mode=1.0)
  - `D_heat_mult`: Heat demand multiplier (placeholder only; default 1.0; not applied in PoC v2)

**Configuration:**
**Path:** `Input/configs/site_decision_robustness.toml` (canonical)
- Fallback search order: `Input/configs/site_decision_robustness.toml` → `configs/site_decision_robustness_min.toml` → `configs/site_decision_robustness.toml`

**Key Settings:**
- Multiplier ranges and distributions (triangular, uniform, or normal)
- Random seed for multiplier generation (default: 42, for reproducibility)
- Satisficing thresholds (shed_fraction_max, upgrade_cost_nzd_max, emissions_enabled, emissions_tonnes_max)

**Thesis Use:** Robustness evaluation showing how site decision (EB vs BB) performs under stylised uncertainty in site economics. Enables non-trivial robustness analysis while maintaining one-pass coupling. The multipliers are stylised uncertainty multipliers used for demonstration and calibration - they represent plausible ranges for electricity prices, biomass scarcity, and carbon prices that could affect the relative competitiveness of EB vs BB pathways.

**Futures Count and Pairing Contract:**

For EB vs BB comparison, the same `future_id` set must exist in:
- `rdm_summary_2035_EB.csv`
- `rdm_summary_2035_BB.csv`
- `Output/runs/<bundle>/rdm/futures.csv` (canonical per bundle)

The overlay module enforces this by filtering canonical `futures.csv` to the `future_id`s present in both RDM summaries.

**Recommended Thesis PoC Settings:**
- **Grid RDM:** 100 futures (expensive part - regional screening)
- **Overlay:** Uses the same 100 paired futures (cheap part - site cost perturbation)

**Note:** You may keep a larger *template* (e.g., 200 rows) in `Input/rdm/futures_2035.csv` for later scaling, but only those futures present in the RDM summaries will be used. The overlay automatically filters to the paired subset.

**How to Scale from 21 → 100 Futures:**
1. Expand `Input/rdm/futures_2035.csv` to 100 rows (`future_id` 0..99) with grid multipliers (U_headroom_mult, U_inc_mult, etc.)
2. Re-run EB and BB grid RDM so both summaries contain those 100 `future_id`s
3. Re-run overlay: `--init-futures-multipliers` → `--validate-only` → generate overlay

**Critical Requirements:**
- RDM summaries for EB and BB must use identical `future_id` sets (paired futures)
- Canonical futures CSV must contain at least all RDM future_ids (can have more, but only paired subset is used)
- If multiplier columns are missing, they default to 1.0 (degenerate robustness)
- Old outputs are archived to `_archive_overlays/YYYYMMDD_HHMMSS/` before replacement

**Windows File Locking (Troubleshooting):**
On Windows, if CSV outputs are open in Excel/preview, writes may fail. The module now uses atomic writes with retries (5 attempts with backoff delays). If it still fails, the error message will indicate which file is locked - close it and re-run.

## Bundle-Level Artefacts

### KPI Table CSV
**Path Template:** `Output/runs/<bundle>/kpi_table_<runid>.csv`

**Generation Command:**
```bash
# Generated by KPI export command (if available)
# Or manually aggregated from dispatch summaries
```

**Purpose:** Aggregated KPIs across epochs produced by the KPI export command.

**Key Columns:** (Varies by implementation, typically includes epoch_tag and key metrics from dispatch summaries)

**Thesis Use:** Cross-epoch comparison table.

**Note:** This file is produced by the KPI export command and is kept as-is by the PoC pipeline (not modified).

### Pathway Comparison CSV
**Path Template:** `Output/runs/<bundle>/compare_pathways_2035_EB_vs_BB.csv`

**Generation Command:**
```bash
python -m src.compare_pathways_2035 --bundle <bundle> --eb-run epoch2035_EB/dispatch/<runid> --bb-run epoch2035_BB/dispatch/<runid> --output-root Output
```

**Purpose:** Side-by-side comparison of EB vs BB pathways with delta metrics.

**Key Columns:**
- `pathway`: Pathway identifier (EB or BB)
- `metric`: Metric name (e.g., `annual_total_cost_nzd`, `avg_cost_nzd_per_MWh_heat`, `electricity_MWh`, `avg_tariff`, `co2_tonnes`, `carbon_cost_NZD`)
- `value`: Metric value for the pathway
- `delta_BB_minus_EB`: Difference (BB - EB)
- `delta_EB_minus_BB`: Difference (EB - BB)

**Thesis Use:** Primary comparison table for 2035 pathway decision.

## Input Artefacts

### Futures CSV Template
**Path:** `Input/rdm/futures_2035.csv`

**Purpose:** Template for creating canonical per-bundle futures CSV. Contains grid uncertainty multipliers for paired EB/BB evaluation.

**Key Columns:**
- `future_id`: Unique future identifier (integer, 0-99 for 100 futures recommended, or 0-199 for 200 futures)
- `U_headroom_mult`: Headroom multiplier (triangular: a=0.75, mode=0.90, b=1.00)
- `U_inc_mult`: Incremental demand multiplier (triangular: a=0.85, mode=1.00, b=1.15)
- `U_upgrade_capex_mult`: Upgrade capex multiplier (triangular: a=0.80, mode=1.00, b=1.50)
- `U_voll`: Value of lost load (NZD/MWh, discrete: {5000, 10000, 15000, 20000} with weights [0.10, 0.40, 0.35, 0.15])
- `U_consents_uplift`: Consents uplift multiplier (triangular: a=1.00, mode=1.20, b=1.60)

**Anchor Futures:** The first 21 futures (future_id 0-20) are preserved exactly as the original PoC set for regression testing and interpretability. These anchors remain bit-for-bit identical across all generations.

**Generation:** Use `scripts/generate_futures_2035.py` to expand from 21 to 100 or 200 futures:
```powershell
# Generate 100 futures (recommended for thesis PoC)
python scripts/generate_futures_2035.py --n 100 --seed 42 --out "Input/rdm/futures_2035.csv"

# Validate
python scripts/validate_futures_2035.py --csv "Input/rdm/futures_2035.csv" --n 100
```

**100 Futures Recommended; 200 Optional:**
- **100 futures:** Recommended for thesis PoC. Provides good coverage of uncertainty space while keeping computational cost manageable.
- **200 futures:** Optional for extended analysis. Use when deeper uncertainty exploration is needed.

**Usage:** This template is copied to `Output/runs/<bundle>/rdm/futures.csv` (canonical futures) on first initialization. Site multiplier columns (P_elec_mult, P_biomass_mult, ETS_mult) are then added to the canonical futures file.

**Thesis Use:** Base uncertainty specification for robustness analysis. The canonical futures.csv per bundle extends this with site-side multipliers for site decision robustness evaluation. Both EB and BB grid RDM must use the same `Input/rdm/futures_2035.csv` template to ensure paired futures contract.

### Upgrade Menu TOML
**Path:** `Input/configs/grid_upgrades_southland_edendale.toml`

**Purpose:** Grid upgrade options with capex and capacity specifications.

**Key Fields:**
- `[[upgrades]]`: Upgrade option definitions
  - `name`: Upgrade name (e.g., `none`, `fonterra_opt1_N_plus21MW`)
  - `capacity_MW`: Upgrade capacity (MW)
  - `capex_nzd`: Capital expenditure (NZD)
  - `lead_time_months`: Lead time (months)
  - `security_level`: Security level (N, N-1, etc.)
- `[assumptions]`: Economic assumptions
  - `real_discount_rate`: Real discount rate
  - `asset_life_years`: Asset life (years)
  - `consents_uplift_factor`: Base consents uplift factor

**Thesis Use:** Decision options for grid upgrade strategies.

## Thesis Pack (Curated Outputs)

**Path Template:** `Output/runs/<bundle>/thesis_pack/`

**Purpose:** Curated tables and figures selected for thesis presentation.

**Structure:**
- `tables/`: Selected CSV tables for thesis
- `figures/`: Selected PNG figures for thesis
- `pointers.md`: Mapping of curated items to source paths

**Generation Command:**
```bash
scripts/run_poc_layers.ps1 -Bundle <bundle> -Layers thesis_pack
```

**Thesis Use:** Final curated outputs for thesis chapters.

---

## Acceptance Checklist (Site Decision Robustness Overlay)

After implementing the site decision robustness overlay, verify:

- [ ] `--validate-only` passes with clear output showing futures count and multiplier status
- [ ] Overlay generation succeeds with closed files (no Excel/preview open)
- [ ] Expected failure message when files are locked: "File appears locked (Excel/preview). Close it and retry: <path>"
- [ ] Canonical futures.csv is created from template on first `--init-futures-multipliers` run
- [ ] Multipliers are reproducible (same seed produces same values)
- [ ] Outputs are archived before replacement (check `_archive_overlays/` folder)
- [ ] CLI output shows: "Canonical futures rows: <n_total>, using paired futures from RDM: <n_used>"
- [ ] Running module twice consecutively does not crash (even if files were previously open)
