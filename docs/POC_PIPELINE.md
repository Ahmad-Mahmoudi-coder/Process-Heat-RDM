# PoC Pipeline Documentation

This document describes the one-pass coupling pipeline for thesis-ready PoC reporting:
**DemandPack → proportional dispatch → incremental electricity export → GXP screening + RDM → robust summaries**

## Folder Conventions

All outputs are organized under `Output/runs/<bundle>/`:

```
Output/runs/<bundle>/
├── epoch2025/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2025_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2025.csv
├── epoch2028/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2028_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2028.csv
├── epoch2035_EB/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2035_EB_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2035_EB.csv
├── epoch2035_BB/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2035_BB_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2035_BB.csv
├── compare/
│   ├── compare_2035_EB_vs_BB.csv
│   └── compare_2035_EB_vs_BB.md
├── rdm/
│   ├── rdm_summary_2035_EB.csv
│   ├── rdm_summary_2035_BB.csv
│   └── rdm_compare_2035_EB_vs_BB.csv
└── kpi_table_capfix1.csv
```

## Key Artefacts

### Site Dispatch Summaries

**Location:** `Output/runs/<bundle>/epoch<epoch_tag>/<run-id>/site_dispatch_<epoch_tag>_summary.csv`

**Key Columns:**
- `unit_id`: Unit identifier (TOTAL row contains system-wide aggregates)
- `annual_total_cost_nzd`: Total annual cost (NZD)
- `annual_electricity_cost_nzd`: Annual electricity cost (NZD)
- `annual_electricity_MWh`: Annual electricity consumption (MWh)
- `avg_electricity_tariff_nzd_per_MWh`: Average electricity tariff (NZD/MWh)
- `annual_co2_tonnes`: Annual CO2 emissions (tonnes)
- `annual_carbon_cost_nzd`: Annual carbon cost (NZD)
- `annual_unserved_MWh`: Annual unserved energy (MWh)
- `annual_unserved_cost_nzd`: Annual unserved cost (NZD)
- `unserved_avg_cost_nzd_per_MWh`: Average unserved cost per MWh (NZD/MWh)

### Incremental Electricity Traces

**Location:** `Output/runs/<bundle>/epoch<epoch_tag>/<run-id>/signals/incremental_electricity_MW_<epoch_tag>.csv`

**Schema:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `incremental_electricity_MW`: Incremental electricity demand (MW)

**Purpose:** Exports hourly incremental electricity demand from site dispatch for regional screening.

### KPI Table

**Location:** `Output/runs/<bundle>/kpi_table_capfix1.csv`

**Purpose:** Aggregated KPIs across epochs (if generated by pipeline).

### Pathway Comparison

**Location:** `Output/runs/<bundle>/compare/compare_2035_EB_vs_BB.csv`

**Schema:**
- `metric`: Metric name (e.g., `annual_total_cost_nzd`)
- `EB_value`: Value for EB pathway
- `BB_value`: Value for BB pathway
- `delta_EB_minus_BB`: Difference (EB - BB)
- `units`: Units for the metric

**Markdown Summary:** `Output/runs/<bundle>/compare/compare_2035_EB_vs_BB.md`

Contains a thesis-ready paragraph summarizing key deltas (cost, electricity, emissions).

## PoC v2 Reporting Overlay: Site Decision Robustness

**Location:** `Output/runs/<bundle>/rdm/site_decision_robustness_*.csv`

**Purpose:** Consolidates site dispatch costs with RDM upgrade costs to evaluate robustness of EB vs BB pathway decisions under uncertainty. Introduces stylised uncertainty multipliers for site costs to make site decision robustness non-trivial while keeping one-pass coupling intact.

**Key Concept:** This is a **post-processing overlay only**. It does NOT:
- Re-run dispatch
- Modify existing artefacts
- Introduce feedback loops
- Change the pipeline order

**What it does:**
- Reads existing dispatch summaries and RDM summaries
- Creates canonical per-bundle futures.csv from template (Input/rdm/futures_2035.csv)
- Generates site-side multipliers (P_elec_mult, P_biomass_mult, ETS_mult) on top of existing grid multipliers
- Applies per-future multipliers to perturb site-side cost components (electricity price, biomass price, carbon price)
- Computes future-costed system costs (site + RDM) for each future
- Evaluates robustness metrics (win rates, regret distributions, satisficing rates)

**Canonical Futures CSV:** `Output/runs/<bundle>/rdm/futures.csv`
- Created from template: `Input/rdm/futures_2035.csv` (contains grid multipliers: U_headroom_mult, U_inc_mult, etc.)
- Site multiplier columns added: `P_elec_mult`, `P_biomass_mult`, `ETS_mult`, `D_heat_mult`
- Must contain exactly the same `future_id` values as RDM summaries (paired futures)
- Multiplier columns can be initialized automatically using `--init-futures-multipliers`

**Multipliers:**
- `P_elec_mult`: Electricity price multiplier (default range: [0.65, 1.35], triangular distribution)
- `P_biomass_mult`: Biomass fuel price multiplier / scarcity proxy (default range: [0.90, 2.50], triangular, mode=1.2)
- `ETS_mult`: Carbon price (ETS) multiplier (default range: [0.80, 2.00], triangular distribution)
- `D_heat_mult`: Heat demand multiplier (placeholder only; default 1.0; not applied in PoC v2)

**Configuration:** `Input/configs/site_decision_robustness.toml` (canonical)
- Fallback search order: `Input/configs/site_decision_robustness.toml` → `configs/site_decision_robustness_min.toml` → `configs/site_decision_robustness.toml`
- Defines multiplier ranges, distributions, satisficing thresholds
- Uses reproducible random seed (default: 42) for multiplier generation

**Generation Workflow:**
```powershell
# Step 1: Initialize canonical futures.csv and site multipliers (first time only)
python -m src.site_decision_robustness --bundle poc_20260105_release02 --init-futures-multipliers

# Step 2: Validate setup (check files, schema, paired futures)
python -m src.site_decision_robustness --bundle poc_20260105_release02 --validate-only

# Step 3: Generate robustness consolidation
python -m src.site_decision_robustness --bundle poc_20260105_release02 --epoch-eb 2035_EB --epoch-bb 2035_BB
```

**Outputs:**
- `site_decision_robustness_2035_EB_vs_BB.csv`: Per-future joined table with baseline and future-costed system costs
- `site_decision_robustness_summary_2035.csv`: Summary metrics (win rates, regret stats, satisficing rates)
- `site_decision_regret_cdf_2035.png`: Regret CDF comparison figure (future-costed)
- `site_decision_system_cost_boxplot_2035.png`: System cost distribution comparison (future-costed)

**Archiving:** Old overlay outputs are archived to `Output/runs/<bundle>/_archive_overlays/YYYYMMDD_HHMMSS/` before replacement.

**Futures Count and Pairing Contract:**

For EB vs BB comparison, the same `future_id` set must exist in:
- `rdm_summary_2035_EB.csv`
- `rdm_summary_2035_BB.csv`
- `Output/runs/<bundle>/rdm/futures.csv` (canonical per bundle)

The overlay module enforces this by filtering canonical `futures.csv` to the `future_id`s present in both RDM summaries.

**Recommended Thesis PoC Settings:**
- **Grid RDM:** 100 futures (expensive part - regional screening)
- **Overlay:** Uses the same 100 paired futures (cheap part - site cost perturbation)

**Note:** You may keep a larger *template* (e.g., 200 rows) in `Input/rdm/futures_2035.csv` for later scaling, but only those futures present in the RDM summaries will be used. The overlay automatically filters to the paired subset.

**How to Scale from 21 → 100 Futures:**
1. Expand `Input/rdm/futures_2035.csv` to 100 rows (`future_id` 0..99) with grid multipliers (U_headroom_mult, U_inc_mult, etc.)
2. Re-run EB and BB grid RDM so both summaries contain those 100 `future_id`s
3. Re-run overlay: `--init-futures-multipliers` → `--validate-only` → generate overlay

**Thesis Use:** Robustness evaluation showing how site decision (EB vs BB) performs under stylised uncertainty in site economics. Enables non-trivial robustness analysis while maintaining one-pass coupling. The multipliers are stylised uncertainty multipliers used for demonstration and calibration - they represent plausible ranges for electricity prices, biomass scarcity, and carbon prices that could affect the relative competitiveness of EB vs BB pathways.

**Windows File Locking (Troubleshooting):**
On Windows, if CSV outputs are open in Excel/preview, writes may fail. The module now uses atomic writes with retries; if it still fails after 5 attempts, close the file and re-run. The error message will indicate which file is locked.

### Generate 100/200 Grid Futures (2035)

**Purpose:** Expand the base 21 futures to 100 (recommended) or 200 (extended analysis) for more robust grid RDM evaluation while preserving the original 21 anchor futures for regression testing and interpretability.

**Why Keep 21 Anchors:**
- Regression testing: Ensures existing results remain reproducible
- Interpretability: Provides a stable reference set for comparison
- Backward compatibility: Existing analyses using futures 0-20 remain valid

**Generation Workflow (PowerShell - Copy-Paste Ready):**
```powershell
# Step 1: Generate 100 futures (recommended for thesis PoC)
python scripts/generate_futures_2035.py --n 100 --seed 42 --out "Input/rdm/futures_2035.csv"

# Step 2: Validate the generated futures
python scripts/validate_futures_2035.py --csv "Input/rdm/futures_2035.csv" --n 100

# Step 3: Update RDM experiment configs to match n_futures
# Edit Input/configs/rdm_experiment_2035_EB.toml: set n_futures = 100
# Edit Input/configs/rdm_experiment_2035_BB.toml: set n_futures = 100

# Step 4: Re-run grid RDM for EB and BB (both must use same futures template)
# This ensures paired futures contract: both summaries contain future_id 0..99
python -m src.run_rdm_2035 --bundle <bundle> --epoch-tag 2035_EB --futures-csv "Input/rdm/futures_2035.csv" ...
python -m src.run_rdm_2035 --bundle <bundle> --epoch-tag 2035_BB --futures-csv "Input/rdm/futures_2035.csv" ...

# Step 5: Run overlay (uses canonical futures.csv created from template)
python -m src.site_decision_robustness --bundle <bundle> --init-futures-multipliers
python -m src.site_decision_robustness --bundle <bundle> --validate-only
python -m src.site_decision_robustness --bundle <bundle> --epoch-eb 2035_EB --epoch-bb 2035_BB
```

**For 200 Futures (Extended Analysis):**
```powershell
# Generate 200 futures
python scripts/generate_futures_2035.py --n 200 --seed 42 --out "Input/rdm/futures_2035.csv"

# Validate
python scripts/validate_futures_2035.py --csv "Input/rdm/futures_2035.csv" --n 200

# Update configs: set n_futures = 200 in both EB and BB configs
# Re-run grid RDM for both pathways
# Re-run overlay
```

**Important Notes:**
- The generator preserves futures 0-20 exactly (bit-for-bit identical)
- New futures (21-99 or 21-199) use Latin Hypercube Sampling (LHS) for continuous variables and weighted discrete sampling for U_voll
- Both EB and BB must use the same `Input/rdm/futures_2035.csv` template to ensure paired futures
- The overlay module automatically filters canonical futures.csv to the future_ids present in RDM summaries

### RDM Summaries

**Location:** `Output/runs/<bundle>/rdm/rdm_summary_<epoch_tag>.csv`

**Schema:**
- `epoch_tag`: Epoch tag (e.g., `2035_EB`)
- `strategy_id`: Strategy ID (e.g., `S_AUTO`)
- `strategy_label`: Strategy label
- `future_id`: Future ID (from `Input/rdm/futures_2035.csv`)
- `selected_upgrade_name`: Selected upgrade option name
- `selected_capacity_MW`: Selected upgrade capacity (MW)
- `annualised_upgrade_cost_nzd`: Annualised upgrade cost (NZD/year)
- `annual_incremental_MWh`: Annual incremental electricity demand (MWh)
- `annual_shed_MWh`: Annual shed energy (MWh)
- `shed_fraction`: Shed fraction (annual_shed_MWh / annual_incremental_MWh)
- `annual_shed_cost_nzd`: Annual shed cost (NZD)
- `total_cost_nzd`: Total cost (upgrade + shed, NZD)
- `n_hours_binding`: Number of hours with binding constraints
- `unserved_peak_MW`: Peak unserved demand (MW)

**Comparison:** `Output/runs/<bundle>/rdm/rdm_compare_2035_EB_vs_BB.csv`

Side-by-side comparison of EB and BB RDM results by `future_id`.

## Acceptance Checklist

Before considering the PoC pipeline complete, verify:

- [ ] All dispatch summaries exist for 2025, 2028, 2035_EB, 2035_BB
- [ ] All incremental electricity CSVs exist in `signals/` folders
- [ ] KPI table exists (if applicable)
- [ ] Pathway comparison CSV and MD exist
- [ ] RDM summaries exist for both 2035_EB and 2035_BB
- [ ] RDM comparison CSV exists
- [ ] **Paired futures:** EB and BB RDM summaries use identical `future_id` sets (from `Input/rdm/futures_2035.csv`)
- [ ] **No penalties:** All dispatch summaries show `annual_unserved_MWh = 0` or acceptable unserved levels
- [ ] **Consistent units:** All cost columns are in NZD, all energy columns are in MWh

## One-Pass Coupling

**Important:** This pipeline implements **one-pass coupling only**. There is no iterative feedback between:
- Site dispatch and regional screening
- Regional screening and site dispatch

The flow is strictly:
1. Site dispatch computes incremental electricity demand
2. Regional screening evaluates grid constraints and upgrade options
3. Results are aggregated and compared

**What is excluded:**
- Iterative tariff updates based on regional screening results
- Feedback from regional constraints to site dispatch quantities
- Multi-pass optimization loops

This design choice ensures:
- Deterministic, reproducible results
- Clear separation of concerns
- Thesis-defensible methodology


