# PoC Pipeline Documentation

This document describes the one-pass coupling pipeline for thesis-ready PoC reporting:
**DemandPack → proportional dispatch → incremental electricity export → GXP screening + RDM → robust summaries**

## Folder Conventions

All outputs are organized under `Output/runs/<bundle>/`:

```
Output/runs/<bundle>/
├── epoch2025/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2025_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2025.csv
├── epoch2028/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2028_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2028.csv
├── epoch2035_EB/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2035_EB_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2035_EB.csv
├── epoch2035_BB/
│   └── dispatch_prop_v2_capfix1/
│       ├── site_dispatch_2035_BB_summary.csv
│       └── signals/
│           └── incremental_electricity_MW_2035_BB.csv
├── compare/
│   ├── compare_2035_EB_vs_BB.csv
│   └── compare_2035_EB_vs_BB.md
├── rdm/
│   ├── rdm_summary_2035_EB.csv
│   ├── rdm_summary_2035_BB.csv
│   └── rdm_compare_2035_EB_vs_BB.csv
└── kpi_table_capfix1.csv
```

## Key Artefacts

### Site Dispatch Summaries

**Location:** `Output/runs/<bundle>/epoch<epoch_tag>/<run-id>/site_dispatch_<epoch_tag>_summary.csv`

**Key Columns:**
- `unit_id`: Unit identifier (TOTAL row contains system-wide aggregates)
- `annual_total_cost_nzd`: Total annual cost (NZD)
- `annual_electricity_cost_nzd`: Annual electricity cost (NZD)
- `annual_electricity_MWh`: Annual electricity consumption (MWh)
- `avg_electricity_tariff_nzd_per_MWh`: Average electricity tariff (NZD/MWh)
- `annual_co2_tonnes`: Annual CO2 emissions (tonnes)
- `annual_carbon_cost_nzd`: Annual carbon cost (NZD)
- `annual_unserved_MWh`: Annual unserved energy (MWh)
- `annual_unserved_cost_nzd`: Annual unserved cost (NZD)
- `unserved_avg_cost_nzd_per_MWh`: Average unserved cost per MWh (NZD/MWh)

### Incremental Electricity Traces

**Location:** `Output/runs/<bundle>/epoch<epoch_tag>/<run-id>/signals/incremental_electricity_MW_<epoch_tag>.csv`

**Schema:**
- `timestamp_utc`: Timestamp (UTC, ISO-8601)
- `incremental_electricity_MW`: Incremental electricity demand (MW)

**Purpose:** Exports hourly incremental electricity demand from site dispatch for regional screening.

### KPI Table

**Location:** `Output/runs/<bundle>/kpi_table_capfix1.csv`

**Purpose:** Aggregated KPIs across epochs (if generated by pipeline).

### Pathway Comparison

**Location:** `Output/runs/<bundle>/compare/compare_2035_EB_vs_BB.csv`

**Schema:**
- `metric`: Metric name (e.g., `annual_total_cost_nzd`)
- `EB_value`: Value for EB pathway
- `BB_value`: Value for BB pathway
- `delta_EB_minus_BB`: Difference (EB - BB)
- `units`: Units for the metric

**Markdown Summary:** `Output/runs/<bundle>/compare/compare_2035_EB_vs_BB.md`

Contains a thesis-ready paragraph summarizing key deltas (cost, electricity, emissions).

### RDM Summaries

**Location:** `Output/runs/<bundle>/rdm/rdm_summary_<epoch_tag>.csv`

**Schema:**
- `epoch_tag`: Epoch tag (e.g., `2035_EB`)
- `strategy_id`: Strategy ID (e.g., `S_AUTO`)
- `strategy_label`: Strategy label
- `future_id`: Future ID (from `Input/rdm/futures_2035.csv`)
- `selected_upgrade_name`: Selected upgrade option name
- `selected_capacity_MW`: Selected upgrade capacity (MW)
- `annualised_upgrade_cost_nzd`: Annualised upgrade cost (NZD/year)
- `annual_incremental_MWh`: Annual incremental electricity demand (MWh)
- `annual_shed_MWh`: Annual shed energy (MWh)
- `shed_fraction`: Shed fraction (annual_shed_MWh / annual_incremental_MWh)
- `annual_shed_cost_nzd`: Annual shed cost (NZD)
- `total_cost_nzd`: Total cost (upgrade + shed, NZD)
- `n_hours_binding`: Number of hours with binding constraints
- `unserved_peak_MW`: Peak unserved demand (MW)

**Comparison:** `Output/runs/<bundle>/rdm/rdm_compare_2035_EB_vs_BB.csv`

Side-by-side comparison of EB and BB RDM results by `future_id`.

## Acceptance Checklist

Before considering the PoC pipeline complete, verify:

- [ ] All dispatch summaries exist for 2025, 2028, 2035_EB, 2035_BB
- [ ] All incremental electricity CSVs exist in `signals/` folders
- [ ] KPI table exists (if applicable)
- [ ] Pathway comparison CSV and MD exist
- [ ] RDM summaries exist for both 2035_EB and 2035_BB
- [ ] RDM comparison CSV exists
- [ ] **Paired futures:** EB and BB RDM summaries use identical `future_id` sets (from `Input/rdm/futures_2035.csv`)
- [ ] **No penalties:** All dispatch summaries show `annual_unserved_MWh = 0` or acceptable unserved levels
- [ ] **Consistent units:** All cost columns are in NZD, all energy columns are in MWh

## One-Pass Coupling

**Important:** This pipeline implements **one-pass coupling only**. There is no iterative feedback between:
- Site dispatch and regional screening
- Regional screening and site dispatch

The flow is strictly:
1. Site dispatch computes incremental electricity demand
2. Regional screening evaluates grid constraints and upgrade options
3. Results are aggregated and compared

**What is excluded:**
- Iterative tariff updates based on regional screening results
- Feedback from regional constraints to site dispatch quantities
- Multi-pass optimization loops

This design choice ensures:
- Deterministic, reproducible results
- Clear separation of concerns
- Thesis-defensible methodology


